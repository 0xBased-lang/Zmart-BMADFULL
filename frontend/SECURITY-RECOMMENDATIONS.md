# Security Recommendations - URGENT

## ðŸš¨ CRITICAL: Exposed API Keys

CodeRabbit detected hardcoded API keys in the following files. These keys **must be rotated immediately**:

### Files with Exposed Keys:
1. `test-live-site.sh` - Supabase anon key
2. `test-api.sh` - Supabase anon key  
3. `get-schema.sh` - Supabase service role key (HIGH RISK!)
4. `insert-markets-complete.sh` - Supabase service role key (HIGH RISK!)
5. `check-market-ids.sh` - Supabase API key
6. `check-bets-schema.sh` - Supabase API key

### Immediate Actions Required:

#### 1. Rotate All Exposed Keys (DO THIS NOW!)

**Go to Supabase Dashboard:**
```
1. Visit: https://supabase.com/dashboard/project/YOUR_PROJECT/settings/api
2. Click "Reset" on both:
   - anon (public) key
   - service_role key
3. Update your .env.local with new keys
4. Update Vercel environment variables with new keys
```

#### 2. Update Scripts to Use Environment Variables

All scripts have been updated to read from environment variables instead of hardcoded values. Before running any script:

```bash
# Source your .env.local file
source .env.local

# Or export manually:
export SUPABASE_URL="your_url"
export SUPABASE_ANON_KEY="your_anon_key"
export SUPABASE_SERVICE_KEY="your_service_role_key"
```

#### 3. Verify .gitignore

Ensure these files are in `.gitignore`:
```gitignore
.env
.env.local
.env*.local
*.key
*.pem
```

#### 4. Clean Git History (Optional but Recommended)

If you want to remove exposed keys from git history:
```bash
# WARNING: This rewrites history - coordinate with team
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch test-api.sh get-schema.sh" \
  --prune-empty --tag-name-filter cat -- --all

# Force push (CAUTION!)
git push origin --force --all
```

## ðŸ”’ Best Practices Going Forward

### 1. Never Commit Secrets
- Always use environment variables
- Use `.env.example` for documentation (no real keys!)
- Add pre-commit hooks to scan for secrets

### 2. Use Different Keys per Environment
```
Development: dev_key_xxx
Staging: staging_key_xxx  
Production: prod_key_xxx
```

### 3. Rotate Keys Regularly
- Every 90 days minimum
- Immediately after any suspected exposure
- When team members leave

### 4. Use Secret Management
Consider using:
- **Vercel:** Built-in environment variables
- **1Password:** For local development
- **Doppler:** For team secret management
- **AWS Secrets Manager:** For production

### 5. Enable Row Level Security (RLS)

In Supabase, enable RLS on all tables:
```sql
ALTER TABLE markets ENABLE ROW LEVEL SECURITY;
ALTER TABLE bets ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_leaderboard ENABLE ROW LEVEL SECURITY;

-- Create policies for each table
-- Example for markets:
CREATE POLICY "Markets are viewable by everyone"
  ON markets FOR SELECT
  USING (true);

CREATE POLICY "Only authenticated users can create markets"
  ON markets FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');
```

### 6. Limit Service Role Key Usage

**Service role key bypasses RLS - use sparingly!**
- Only use for admin scripts
- Never expose in client-side code
- Consider creating limited admin roles instead

## ðŸ“Š Security Checklist

- [ ] Rotated all exposed API keys in Supabase
- [ ] Updated .env.local with new keys
- [ ] Updated Vercel environment variables
- [ ] Verified .gitignore includes .env files
- [ ] Tested all scripts with environment variables
- [ ] Enabled RLS on all tables
- [ ] Created appropriate RLS policies
- [ ] Documented key rotation schedule
- [ ] Set up secret scanning in CI/CD
- [ ] Reviewed access logs for suspicious activity

## ðŸ”— Resources

- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/row-level-security)
- [OWASP API Security](https://owasp.org/www-project-api-security/)
- [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)

---

**Generated by CodeRabbit Analysis**  
**Date:** $(date)  
**Priority:** CRITICAL
